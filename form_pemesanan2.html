<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Pemesanan Makanan - Shopee Food Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Gaya dasar untuk body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Mengatur item ke atas */
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        /* Gaya untuk container utama form */
        .container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 800px; /* Lebar maksimum untuk form */
            padding: 30px;
            box-sizing: border-box;
        }
        /* Gaya untuk judul utama */
        h1 {
            color: #ee4d2d; /* Warna oranye khas Shopee */
            font-size: 2.25rem; /* Ukuran teks besar */
            font-weight: 700; /* Tebal */
            margin-bottom: 25px;
            text-align: center;
        }
        /* Gaya untuk judul bagian */
        .section-title {
            color: #333;
            font-size: 1.5rem; /* Ukuran teks menengah */
            font-weight: 600; /* Setengah tebal */
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 2px solid #ee4d2d; /* Garis bawah oranye */
            padding-bottom: 5px;
        }
        /* Gaya untuk label input */
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        /* Gaya untuk input teks dan textarea */
        input[type="text"],
        input[type="tel"],
        textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
            color: #333;
            transition: border-color 0.3s ease;
        }
        /* Gaya fokus untuk input teks dan textarea */
        input[type="text"]:focus,
        input[type="tel"]:focus,
        textarea:focus {
            outline: none;
            border-color: #ee4d2d;
            box-shadow: 0 0 0 3px rgba(238, 77, 45, 0.2);
        }
        /* Gaya untuk grup radio dan checkbox */
        .radio-group label,
        .checkbox-group label {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        /* Gaya hover untuk grup radio dan checkbox */
        .radio-group label:hover,
        .checkbox-group label:hover {
            background-color: #fffaf7;
            border-color: #ee4d2d;
        }
        /* Gaya input checkbox */
        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
            accent-color: #ee4d2d; /* Warna aksen oranye */
        }
        /* Gaya untuk setiap item menu */
        .menu-item {
            display: flex;
            align-items: center; /* Menyelaraskan item secara vertikal di tengah */
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px dashed #eee;
        }
        /* Menghilangkan border bawah untuk item menu terakhir */
        .menu-item:last-child {
            border-bottom: none;
        }
        /* Container untuk gambar dan detail menu */
        .menu-item-content {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        /* Detail teks item menu */
        .menu-item-details {
            flex-grow: 1;
        }
        /* Judul item menu */
        .menu-item-details h3 {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        /* Harga item menu */
        .menu-item-details p {
            color: #777;
            font-size: 0.9rem;
        }
        /* Aksi tombol untuk item (tambah/kurang) */
        .item-actions {
            display: flex;
            align-items: center;
        }
        /* Tombol kontrol kuantitas */
        .item-quantity-control button {
            background-color: #ee4d2d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            box-shadow: 0 2px 5px rgba(238, 77, 45, 0.3);
        }
        /* Gaya hover untuk tombol kontrol kuantitas */
        .item-quantity-control button:hover {
            background-color: #d13d23;
        }
        /* Teks kuantitas di kontrol */
        .item-quantity-control span {
            margin: 0 12px;
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }
        /* Tombol "Tambah" ke keranjang */
        .add-to-cart-btn {
            background-color: #ee4d2d;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        /* Gaya hover untuk tombol "Tambah" */
        .add-to-cart-btn:hover {
            background-color: #d13d23;
        }
        /* Baris ringkasan pesanan */
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 1.05rem;
            color: #333;
        }
        /* Baris total di ringkasan pesanan */
        .summary-row.total {
            font-weight: 700;
            font-size: 1.3rem;
            color: #ee4d2d;
            border-top: 1px solid #eee;
            padding-top: 15px;
            margin-top: 10px;
        }
        /* Tombol "Pesan Sekarang" */
        .order-button {
            width: 100%;
            padding: 15px;
            background-color: #ee4d2d;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.25rem; /* Ukuran teks besar */
            font-weight: 700; /* Tebal */
            cursor: pointer;
            margin-top: 30px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        /* Gaya hover untuk tombol pesan */
        .order-button:hover {
            background-color: #d13d23;
            transform: translateY(-2px);
        }
        /* Gaya aktif untuk tombol pesan */
        .order-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }
        /* Kelas untuk menyembunyikan elemen */
        .hidden {
            display: none;
        }
        /* Gaya untuk kotak pesan pop-up */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0; /* Awalnya tersembunyi */
            transition: opacity 0.3s ease-in-out;
        }
        /* Kelas untuk menampilkan kotak pesan */
        .message-box.show {
            opacity: 1;
        }
        /* Gaya untuk bagian menu per restoran */
        .restaurant-menu-section {
            margin-top: 25px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        /* Judul restoran di bagian menu */
        .restaurant-menu-section h4 {
            color: #ee4d2d;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 15px;
        }
        /* Gaya untuk gambar menu */
        .menu-item img {
            width: 64px; /* Lebar 64px */
            height: 64px; /* Tinggi 64px */
            border-radius: 8px; /* Sudut membulat */
            object-fit: cover; /* Memastikan gambar mengisi area tanpa terdistorsi */
            margin-right: 16px; /* Jarak kanan */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Form Pemesanan Makanan</h1>

        <!-- Kotak Pesan untuk menampilkan notifikasi kepada pengguna -->
        <div id="messageBox" class="message-box"></div>

        <!-- Form utama untuk pemesanan makanan -->
        <form id="orderForm" action="https://formspree.io/f/mdkzpayq" method="POST">
            <!-- Bagian Detail Pelanggan -->
            <div class="customer-details">
                <h2 class="section-title">Detail Pelanggan</h2>
                <label for="fullName">Nama Lengkap:</label>
                <input type="text" id="fullName" name="fullName" class="rounded-lg" placeholder="Masukkan nama lengkap Anda" required>

                <label for="phoneNumber">Nomor Telepon:</label>
                <input type="tel" id="phoneNumber" name="phoneNumber" class="rounded-lg" placeholder="Contoh: 081234567890" required>

                <label for="deliveryAddress">Alamat Pengiriman:</label>
                <textarea id="deliveryAddress" name="deliveryAddress" rows="3" class="rounded-lg" placeholder="Masukkan alamat lengkap pengiriman Anda" required></textarea>

                <label for="courierNotes">Catatan untuk Kurir (opsional):</label>
                <textarea id="courierNotes" name="courierNotes" rows="2" class="rounded-lg" placeholder="Contoh: Belok kiri setelah pos satpam"></textarea>
            </div>

            <!-- Bagian Pilih Restoran & Menu -->
            <div class="restaurant-menu">
                <h2 class="section-title">Pilih Restoran</h2>
                <!-- Grup checkbox untuk memilih banyak restoran -->
                <div class="checkbox-group mb-6" id="restaurantSelection">
                    <label>
                        <input type="checkbox" name="selectedRestaurant[]" value="Restaurant Ayam Pak Mail" data-delivery-fee="10000">
                        <span class="font-semibold text-lg">Restaurant Ayam Pak Mail</span>
                        <span class="ml-auto text-sm text-gray-500">Biaya Antar: Rp10.000</span>
                    </label>
                    <label>
                        <input type="checkbox" name="selectedRestaurant[]" value="Restaurant Ayam Pak Gembus" data-delivery-fee="11000">
                        <span class="font-semibold text-lg">Restaurant Ayam Pak Gembus</span>
                        <span class="ml-auto text-sm text-gray-500">Biaya Antar: Rp11.000</span>
                    </label>
                    <label>
                        <input type="checkbox" name="selectedRestaurant[]" value="Restaurant Ayam Bensu" data-delivery-fee="12000">
                        <span class="font-semibold text-lg">Restaurant Ayam Bensu</span>
                        <span class="ml-auto text-sm text-gray-500">Biaya Antar: Rp12.000</span>
                    </label>
                </div>

                <!-- Bagian Menu (akan ditampilkan secara dinamis oleh JavaScript) -->
                <h2 class="section-title" id="menuTitle" class="hidden">Menu Restoran</h2>
                <div id="menuContainer" class="hidden">
                    <!-- Menu akan dimuat di sini oleh JavaScript -->
                </div>
            </div>

            <!-- Bagian Ringkasan Pesanan (data akan dikirim melalui input tersembunyi) -->
            <div class="order-summary mt-8">
                <h2 class="section-title">Ringkasan Pesanan</h2>
                <div class="summary-row">
                    <span>Restoran:</span>
                    <span id="summaryRestaurant">Belum dipilih</span>
                </div>
                <div class="summary-row">
                    <span>Pesanan Anda:</span>
                </div>
                <div id="summaryItems" class="mb-4 pl-4 text-sm text-gray-700">
                    <p>Belum ada item ditambahkan.</p>
                </div>
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="summarySubtotal">Rp0</span>
                </div>
                <div class="summary-row">
                    <span>Biaya Pengiriman:</span>
                    <span id="summaryDeliveryFee">Rp0</span>
                </div>
                <div class="summary-row total">
                    <span>Total Pembayaran:</span>
                    <span id="summaryTotal">Rp0</span>
                </div>
                <!-- Input tersembunyi untuk mengirim ringkasan pesanan ke Formspree -->
                <input type="hidden" name="summaryRestaurantList" id="summaryRestaurantHidden">
                <input type="hidden" name="summaryItemList" id="summaryItemsHidden">
                <input type="hidden" name="summarySubtotalAmount" id="summarySubtotalHidden">
                <input type="hidden" name="summaryDeliveryFeeAmount" id="summaryDeliveryFeeHidden">
                <input type="hidden" name="summaryTotalAmount" id="summaryTotalHidden">
            </div>

            <!-- Bagian Metode Pembayaran -->
            <div class="payment-method mt-8">
                <h2 class="section-title">Metode Pembayaran</h2>
                <div class="radio-group" id="paymentMethod">
                    <label>
                        <input type="radio" name="paymentMethod" value="E-wallet" checked>
                        <span>Saldo (E-wallet/Dompet Digital)</span>
                    </label>
                    <label>
                        <input type="radio" name="paymentMethod" value="Bank Transfer">
                        <span>Transfer Bank (Mohon lampirkan bukti transfer)</span>
                    </label>
                    <label>
                        <input type="radio" name="paymentMethod" value="COD">
                        <span>Tunai di Tempat (COD)</span>
                    </label>
                </div>
            </div>

            <!-- Bagian Konfirmasi Pesanan -->
            <div class="confirmation mt-8">
                <label class="flex items-center text-md cursor-pointer">
                    <input type="checkbox" id="agreeTerms" name="agreeTerms" class="mr-3 transform scale-125 accent-orange-500" value="yes" required>
                    Saya menyetujui <a href="#" class="text-orange-500 hover:underline ml-1">Syarat dan Ketentuan</a>.
                </label>
            </div>

            <!-- Tombol "Pesan Sekarang". Type diubah menjadi "button" untuk mencegah submit otomatis browser. -->
            <button type="button" id="orderButton" class="order-button">Pesan Sekarang</button>
        </form>
    </div>

    <script>
        // Objek data restoran, menu, dan biaya pengiriman
        const restaurants = {
            "Restaurant Ayam Pak Mail": {
                deliveryFee: 10000,
                menu: [
                    { id: 'ayam_goreng_mail', name: 'Ayam Goreng', price: 10000, category: 'Makanan', imageUrl: 'https://placehold.co/64x64/FFBEB4/663322?text=Ayam+Goreng+1' },
                    { id: 'nasi_goreng_mail', name: 'Nasi Goreng', price: 11000, category: 'Makanan', imageUrl: 'https://placehold.co/64x64/FFF7D4/665533?text=Nasi+Goreng+1' },
                    { id: 'bebek_goreng_mail', name: 'Bebek Goreng', price: 12000, category: 'Makanan', imageUrl: 'https://placehold.co/64x64/E0E0E0/444444?text=Bebek+Goreng+1' },
                    { id: 'es_degan_mail', name: 'Es Degan', price: 10000, category: 'Minuman', imageUrl: 'https://placehold.co/64x64/D4F0D4/336633?text=Es+Degan+1' },
                    { id: 'es_jeruk_mail', name: 'Es Jeruk', price: 9000, category: 'Minuman', imageUrl: 'https://placehold.co/64x64/FFF2CD/FFA500?text=Es+Jeruk+1' },
                    { id: 'es_teh_mail', name: 'Es Teh', price: 8000, category: 'Minuman', imageUrl: 'https://placehold.co/64x64/DCEBEE/4A789A?text=Es+Teh+1' }
                ]
            },
            "Restaurant Ayam Pak Gembus": {
                deliveryFee: 11000,
                menu: [
                    { id: 'ayam_goreng_gembus', name: 'Ayam Goreng', price: 10000, category: 'Makanan', imageUrl: 'https://placehold.co/64x64/FFCFCF/AA4444?text=Ayam+Goreng+2' },
                    { id: 'nasi_goreng_gembus', name: 'Nasi Goreng', price: 11000, category: 'Makanan', imageUrl: 'https://placehold.co/64x64/FFF0E0/997755?text=Nasi+Goreng+2' },
                    { id: 'bebek_goreng_gembus', name: 'Bebek Goreng', price: 12000, category: 'Makanan', imageUrl: 'https://placehold.co/64x64/D0D0D0/666666?text=Bebek+Goreng+2' },
                    { id: 'bakso_gembus', name: 'Bakso', price: 15000, category: 'Makanan', imageUrl: 'https://placehold.co/64x64/FFDEDE/AA0000?text=Bakso+2' },
                    { id: 'nasi_padang_gembus', name: 'Nasi Padang', price: 20000, category: 'Makanan', imageUrl: 'https://placehold.co/64x64/C0EBC0/228844?text=Nasi+Padang+2' },
                    { id: 'es_legen_gembus', name: 'Es Legen', price: 4000, category: 'Minuman', imageUrl: 'https://placehold.co/64x64/B0E0B0/007700?text=Es+Legen+2' },
                    { id: 'es_campur_gembus', name: 'Es Campur', price: 5000, category: 'Minuman', imageUrl: 'https://placehold.co/64x64/FFECC0/FFBB00?text=Es+Campur+2' },
                    { id: 'es_gudir_gembus', name: 'Es Gudir', price: 6000, category: 'Minuman', imageUrl: 'https://placehold.co/64x64/C0DDC0/555555?text=Es+Gudir+2' },
                    { id: 'pisang_goreng_gembus', name: 'Pisang Goreng', price: 5000, category: 'Cemilan', imageUrl: 'https://placehold.co/64x64/FFECB3/DDCC00?text=Pisang+Goreng+2' },
                    { id: 'tahu_isi_gembus', name: 'Tahu Isi', price: 6000, category: 'Cemilan', imageUrl: 'https://placehold.co/64x64/C0EFFC/5588BB?text=Tahu+Isi+2' },
                    { id: 'tahu_sumedang_gembus', name: 'Tahu Sumedang', price: 7000, category: 'Cemilan', imageUrl: 'https://placehold.co/64x64/FFFAE0/BBBB00?text=Tahu+Sumedang+2' }
                ]
            },
            "Restaurant Ayam Bensu": {
                deliveryFee: 12000,
                menu: [
                    { id: 'ayam_goreng_bensu', name: 'Ayam Goreng', price: 10000, category: 'Makanan', imageUrl: 'https://placehold.co/64x64/FFB0B0/773333?text=Ayam+Goreng+3' },
                    { id: 'nasi_goreng_bensu', name: 'Nasi Goreng', price: 11000, category: 'Makanan', imageUrl: 'https://placehold.co/64x64/FFF0C0/776644?text=Nasi+Goreng+3' },
                    { id: 'bebek_goreng_bensu', name: 'Bebek Goreng', price: 12000, category: 'Makanan', imageUrl: 'https://placehold.co/64x64/C0C0C0/555555?text=Bebek+Goreng+3' },
                    { id: 'sate_bensu', name: 'Sate', price: 17000, category: 'Makanan', imageUrl: 'https://placehold.co/64x64/FFECEC/CC0000?text=Sate+3' },
                    { id: 'lontong_mie_bensu', name: 'Lontong Mie', price: 21000, category: 'Makanan', imageUrl: 'https://placehold.co/64x64/C0D0FF/6688CC?text=Lontong+Mie+3' },
                    { id: 'pisang_ijo_bensu', name: 'Es Pisang Ijo', price: 16000, category: 'Minuman', imageUrl: 'https://placehold.co/64x64/D0FFD0/009900?text=Es+Pisang+Ijo+3' },
                    { id: 'air_mineral_bensu', name: 'Air Mineral', price: 3000, category: 'Minuman', imageUrl: 'https://placehold.co/64x64/DAF2FF/99CCFF?text=Air+Mineral+3' }
                ]
            }
        };

        let selectedRestaurants = []; // Array untuk menyimpan restoran yang dipilih
        let cart = {}; // Objek untuk menyimpan item di keranjang { itemId: { quantity: X, price: Y, name: Z, options: {}, notes: '' } }
        let totalDeliveryFee = 0; // Total biaya pengiriman

        // Mendapatkan referensi ke elemen-elemen DOM yang dibutuhkan
        const restaurantSelection = document.getElementById('restaurantSelection');
        const menuContainer = document.getElementById('menuContainer');
        const menuTitle = document.getElementById('menuTitle');
        const summaryRestaurant = document.getElementById('summaryRestaurant');
        const summaryItems = document.getElementById('summaryItems');
        const summarySubtotal = document.getElementById('summarySubtotal');
        const summaryDeliveryFee = document.getElementById('summaryDeliveryFee');
        const summaryTotal = document.getElementById('summaryTotal');
        const orderButton = document.getElementById('orderButton');
        const agreeTerms = document.getElementById('agreeTerms');
        const messageBox = document.getElementById('messageBox');
        const orderForm = document.getElementById('orderForm');

        /**
         * Menampilkan pesan temporer di kotak pesan.
         * @param {string} message - Pesan yang akan ditampilkan.
         * @param {number} duration - Durasi pesan ditampilkan dalam milidetik.
         */
        function showMessage(message, duration = 3000) {
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        /**
         * Memformat angka menjadi format mata uang Rupiah.
         * @param {number} number - Angka yang akan diformat.
         * @returns {string} - String angka dalam format Rupiah.
         */
        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }

        /**
         * Mengumpulkan detail opsi (checkbox/radio) dan catatan dari DOM untuk item tertentu.
         * Ini penting agar data di 'cart' selalu sinkron dengan apa yang terlihat/diinput di UI.
         * @param {string} itemId - ID item yang detailnya akan dikumpulkan.
         */
        function collectItemDetailsFromDOM(itemId) {
            const itemDiv = document.querySelector(`[data-item-id="${itemId}"]`);
            if (!itemDiv || !cart[itemId]) return; // Pastikan elemen item dan item di keranjang ada

            // Reset opsi dan catatan di keranjang untuk item ini sebelum mengumpulkan ulang
            cart[itemId].options = {};
            cart[itemId].notes = '';

            // Kumpulkan opsi checkbox
            itemDiv.querySelectorAll('input[type="checkbox"][data-parent-item="' + itemId + '"]').forEach(checkbox => {
                if (checkbox.checked) {
                    const optionId = checkbox.dataset.optionId;
                    const optionName = checkbox.dataset.optionName;
                    const optionPrice = parseFloat(checkbox.dataset.optionPrice);
                    cart[itemId].options[optionId] = { type: 'checkbox', name: optionName, price: optionPrice };
                }
            });

            // Kumpulkan opsi radio button
            // Iterasi melalui nama grup radio button yang unik dalam item ini
            const radioGroups = new Set();
            itemDiv.querySelectorAll('input[type="radio"][data-parent-item="' + itemId + '"]').forEach(radio => {
                radioGroups.add(radio.name);
            });

            radioGroups.forEach(groupName => {
                const selectedRadio = itemDiv.querySelector(`input[type="radio"][name="${groupName}"]:checked`);
                if (selectedRadio) {
                    const optionName = selectedRadio.dataset.optionName;
                    const selectedValue = selectedRadio.value;
                    cart[itemId].options[optionName] = { type: 'radio', optionName: optionName, value: selectedValue };
                }
            });

            // Kumpulkan catatan
            const noteInput = itemDiv.querySelector(`#note-${itemId}`);
            if (noteInput && noteInput.value.trim() !== '') {
                cart[itemId].notes = noteInput.value.trim();
            }
        }


        /**
         * Memuat dan menampilkan menu untuk semua restoran yang dipilih oleh pengguna.
         * Fungsi ini juga memperbarui biaya pengiriman total dan ringkasan.
         */
        function loadMenuForSelectedRestaurants() {
            menuContainer.innerHTML = ''; // Kosongkan tampilan menu sebelumnya
            cart = {}; // Kosongkan keranjang saat pilihan restoran berubah
            updateSummary(); // Perbarui ringkasan untuk membersihkan tampilan item

            // Dapatkan semua restoran yang sedang dipilih dari checkbox
            selectedRestaurants = Array.from(document.querySelectorAll('input[name="selectedRestaurant[]"]:checked')).map(checkbox => checkbox.value);

            // Perbarui tampilan ringkasan restoran
            if (selectedRestaurants.length > 0) {
                summaryRestaurant.textContent = selectedRestaurants.join(', ');
                menuTitle.classList.remove('hidden');
                menuContainer.classList.remove('hidden');
            } else {
                summaryRestaurant.textContent = 'Belum dipilih';
                menuTitle.classList.add('hidden');
                menuContainer.classList.add('hidden');
            }

            // Jika tidak ada restoran yang dipilih, reset total biaya pengiriman dan perbarui ringkasan
            if (selectedRestaurants.length === 0) {
                totalDeliveryFee = 0;
                updateSummary();
                return;
            }

            // Hitung total biaya pengiriman dari semua restoran yang dipilih
            totalDeliveryFee = 0;
            selectedRestaurants.forEach(restaurantName => {
                totalDeliveryFee += restaurants[restaurantName].deliveryFee;
            });

            // Tampilkan menu untuk setiap restoran yang dipilih
            selectedRestaurants.forEach(restaurantName => {
                const restaurantMenuData = restaurants[restaurantName].menu;
                if (restaurantMenuData) {
                    const restaurantSection = document.createElement('div');
                    restaurantSection.className = 'restaurant-menu-section';
                    restaurantSection.innerHTML = `<h4>${restaurantName}</h4>`;
                    menuContainer.appendChild(restaurantSection);

                    // Kelompokkan menu berdasarkan kategori (Makanan, Minuman, Cemilan)
                    const categories = {};
                    restaurantMenuData.forEach(item => {
                        if (!categories[item.category]) {
                            categories[item.category] = [];
                        }
                        categories[item.category].push(item);
                    });

                    const orderedCategories = ['Makanan', 'Minuman', 'Cemilan'];
                    orderedCategories.forEach(category => {
                        if (categories[category] && categories[category].length > 0) {
                            const categoryTitle = document.createElement('h3');
                            categoryTitle.className = 'font-semibold text-xl mt-6 mb-3 text-gray-800';
                            categoryTitle.textContent = category;
                            restaurantSection.appendChild(categoryTitle);

                            // Tampilkan setiap item dalam kategori
                            categories[category].forEach(item => {
                                const itemDiv = document.createElement('div');
                                itemDiv.className = 'menu-item';
                                itemDiv.dataset.itemId = item.id; // Menyimpan ID item di elemen DOM

                                itemDiv.innerHTML = `
                                    <div class="menu-item-content">
                                        ${item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.name}" onerror="this.onerror=null;this.src='https://placehold.co/64x64/f0f0f0/666666?text=No+Image';">` : ''}
                                        <div class="menu-item-details">
                                            <h3>${item.name}</h3>
                                            <p>${formatRupiah(item.price)}</p>
                                            <div id="options-${item.id}" class="text-sm text-gray-600 mt-2"></div>
                                            ${item.note ? `<textarea id="note-${item.id}" rows="1" class="rounded-lg w-full mt-2 p-2 text-sm border border-gray-300" placeholder="Catatan untuk item ini..."></textarea>` : ''}
                                        </div>
                                    </div>
                                    <div class="item-actions flex items-center">
                                        <button class="add-to-cart-btn" data-item-id="${item.id}" data-item-name="${item.name}" data-item-price="${item.price}">Tambah</button>
                                        <div class="item-quantity-control hidden">
                                            <button class="remove-from-cart" data-item-id="${item.id}">-</button>
                                            <span id="quantity-${item.id}">0</span>
                                            <button class="add-to-cart" data-item-id="${item.id}" data-item-name="${item.name}" data-item-price="${item.price}">+</button>
                                        </div>
                                    </div>
                                `;
                                restaurantSection.appendChild(itemDiv);

                                // Tambahkan opsi jika ada
                                if (item.options) {
                                    const optionsDiv = itemDiv.querySelector(`#options-${item.id}`);
                                    item.options.forEach(option => {
                                        const optionGroup = document.createElement('div');
                                        optionGroup.className = 'mt-1';
                                        if (option.type === 'checkbox') {
                                            optionGroup.innerHTML = `
                                                <label class="inline-flex items-center mr-4">
                                                    <input type="checkbox" class="form-checkbox text-orange-500 rounded-md" data-option-id="${option.id}" data-option-name="${option.name}" data-option-price="${option.price}" data-parent-item="${item.id}">
                                                    <span class="ml-1">${option.name} (+${formatRupiah(option.price)})</span>
                                                </label>
                                            `;
                                        } else if (option.type === 'radio') {
                                            optionGroup.innerHTML = `
                                                <span class="font-medium mr-2">${option.name}:</span>
                                                ${option.choices.map(choice => `
                                                    <label class="inline-flex items-center mr-4">
                                                        <input type="radio" name="${option.id}-${item.id}" class="form-radio text-orange-500" value="${choice}" data-parent-item="${item.id}" data-option-name="${option.name}">
                                                        <span class="ml-1">${choice}</span>
                                                    </label>
                                                `).join('')}
                                            `;
                                        }
                                        optionsDiv.appendChild(optionGroup);
                                    });
                                }
                            });
                        }
                    });
                }
            });
            updateSummary(); // Perbarui ringkasan setelah semua menu dimuat dan biaya pengiriman dihitung
        }

        /**
         * Memperbarui ringkasan pesanan di UI dan mengisi input tersembunyi
         * yang akan dikirimkan ke Formspree.
         */
        function updateSummary() {
            let subtotal = 0;
            summaryItems.innerHTML = ''; // Kosongkan daftar item di ringkasan

            const itemsInCart = Object.values(cart); // Dapatkan semua item di keranjang
            if (itemsInCart.length === 0) {
                summaryItems.innerHTML = '<p>Belum ada item ditambahkan.</p>';
            } else {
                itemsInCart.forEach(item => {
                    let itemPrice = item.price * item.quantity;
                    let optionDetails = [];
                    if (item.options) {
                        for (const optionId in item.options) {
                            const option = item.options[optionId];
                            if (option.type === 'checkbox') {
                                itemPrice += option.price * item.quantity;
                                optionDetails.push(`${option.name} (${formatRupiah(option.price)})`);
                            } else if (option.type === 'radio') {
                                optionDetails.push(`${option.optionName}: ${option.value}`);
                            }
                        }
                    }

                    const p = document.createElement('p');
                    let textContent = `${item.name} x ${item.quantity} - ${formatRupiah(itemPrice)}`;
                    if (optionDetails.length > 0) {
                        textContent += ` (${optionDetails.join(', ')})`;
                    }
                    if (item.notes) {
                        textContent += ` [Catatan: ${item.notes}]`;
                    }
                    p.textContent = textContent;
                    summaryItems.appendChild(p);
                    subtotal += itemPrice;
                });
            }

            // Perbarui tampilan ringkasan
            summarySubtotal.textContent = formatRupiah(subtotal);
            summaryDeliveryFee.textContent = formatRupiah(totalDeliveryFee);
            summaryTotal.textContent = formatRupiah(subtotal + totalDeliveryFee);

            // Mengisi input tersembunyi untuk pengiriman ke Formspree
            document.getElementById('summaryRestaurantHidden').value = selectedRestaurants.join(', ');
            document.getElementById('summarySubtotalHidden').value = subtotal;
            document.getElementById('summaryDeliveryFeeHidden').value = totalDeliveryFee;
            document.getElementById('summaryTotalHidden').value = subtotal + totalDeliveryFee;

            // Mempersiapkan detail item keranjang untuk pengiriman
            const itemsForSubmission = itemsInCart.map(item => {
                let itemString = `${item.name} x ${item.quantity}`;
                if (item.options && Object.keys(item.options).length > 0) {
                    const opts = [];
                    for (const optKey in item.options) {
                        const opt = item.options[optKey];
                        if (opt.type === 'checkbox') {
                            opts.push(`${opt.name} (+${formatRupiah(opt.price)})`);
                        } else if (opt.type === 'radio') {
                            opts.push(`${opt.optionName}: ${opt.value}`);
                        }
                    }
                    itemString += ` (${opts.join(', ')})`;
                }
                if (item.notes) {
                    itemString += ` [Catatan: ${item.notes}]`;
                }
                return itemString;
            });
            document.getElementById('summaryItemsHidden').value = itemsForSubmission.join('; '); // Gabungkan dengan titik koma untuk keterbacaan di Formspree
        }

        // Event listener untuk perubahan pilihan restoran (saat checkbox dicentang/dihilangkan)
        restaurantSelection.addEventListener('change', (event) => {
            if (event.target.name === 'selectedRestaurant[]') {
                loadMenuForSelectedRestaurants(); // Muat ulang menu saat pilihan restoran berubah
            }
        });

        // Event listener untuk interaksi tombol tambah/kurang kuantitas dan opsi menu
        menuContainer.addEventListener('click', (event) => {
            const target = event.target;
            const itemId = target.dataset.itemId;

            if (!itemId) return; // Keluar jika elemen yang diklik tidak memiliki data-item-id

            if (target.classList.contains('add-to-cart-btn')) {
                const itemName = target.dataset.itemName;
                const itemPrice = parseFloat(target.dataset.itemPrice);

                if (cart[itemId]) {
                    cart[itemId].quantity++;
                } else {
                    cart[itemId] = {
                        quantity: 1,
                        name: itemName,
                        price: itemPrice,
                        options: {},
                        notes: ''
                    };
                }

                // Setelah menambahkan/mengubah kuantitas, kumpulkan detail opsi dan catatan dari DOM
                collectItemDetailsFromDOM(itemId);

                // Perbarui tampilan kuantitas dan sembunyikan tombol "Tambah"
                const addToCartBtn = target;
                const itemQuantityControl = addToCartBtn.nextElementSibling;
                if (addToCartBtn) addToCartBtn.classList.add('hidden');
                if (itemQuantityControl) {
                    itemQuantityControl.classList.remove('hidden');
                    document.getElementById(`quantity-${itemId}`).textContent = cart[itemId].quantity;
                }
                updateSummary(); // Perbarui ringkasan

            } else if (target.classList.contains('add-to-cart')) {
                // Tombol '+' diklik
                if (cart[itemId]) {
                    cart[itemId].quantity++;
                    document.getElementById(`quantity-${itemId}`).textContent = cart[itemId].quantity;
                    updateSummary();
                }
            } else if (target.classList.contains('remove-from-cart')) {
                // Tombol '-' diklik
                if (cart[itemId]) {
                    cart[itemId].quantity--;
                    if (cart[itemId].quantity <= 0) {
                        delete cart[itemId]; // Hapus item dari keranjang jika kuantitas <= 0
                        const addToCartBtn = target.closest('.item-actions').querySelector('.add-to-cart-btn');
                        const itemQuantityControl = target.closest('.item-quantity-control');
                        if (addToCartBtn) addToCartBtn.classList.remove('hidden');
                        if (itemQuantityControl) itemQuantityControl.classList.add('hidden');
                    } else {
                        document.getElementById(`quantity-${itemId}`).textContent = cart[itemId].quantity;
                    }
                    updateSummary();
                }
            }
        });

        // Event listener untuk perubahan opsi (checkbox/radio) dan catatan pada item menu
        menuContainer.addEventListener('change', (event) => {
            const target = event.target;
            // Dapatkan itemId dari data-parent-item (untuk opsi) atau dari id textarea (untuk catatan)
            const itemId = target.dataset.parentItem || (target.id && target.id.startsWith('note-') ? target.id.replace('note-', '') : null);

            if (!itemId || !cart[itemId]) return; // Keluar jika item tidak ada di keranjang

            collectItemDetailsFromDOM(itemId); // Kumpulkan detail terbaru dari DOM
            updateSummary(); // Perbarui ringkasan
        });

        // **Penting: Event listener ini MENCEGAH pengiriman form otomatis saat menekan Enter**
        orderForm.addEventListener('submit', (event) => {
            event.preventDefault(); // Mencegah perilaku default submit form (yaitu me-restart halaman)
        });

        // Event listener untuk tombol "Pesan Sekarang" (Hanya terpicu oleh KLIK pengguna)
        orderButton.addEventListener('click', async () => {
            // Dapatkan nilai dari input pelanggan
            const fullName = document.getElementById('fullName').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const deliveryAddress = document.getElementById('deliveryAddress').value;
            const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked'); // Dapatkan elemen radio yang dipilih

            // Validasi form
            if (!fullName || !phoneNumber || !deliveryAddress) {
                showMessage("Harap lengkapi semua detail pelanggan (Nama, Telepon, Alamat).", 4000);
                return;
            }

            if (selectedRestaurants.length === 0) {
                showMessage("Harap pilih setidaknya satu restoran terlebih dahulu.", 4000);
                return;
            }

            if (Object.keys(cart).length === 0) {
                showMessage("Keranjang Anda kosong. Harap tambahkan menu terlebih dahulu.", 4000);
                return;
            }

            if (!selectedPaymentMethod) { // Periksa apakah ada metode pembayaran yang dipilih
                showMessage("Harap pilih metode pembayaran.", 4000);
                return;
            }

            if (!agreeTerms.checked) {
                showMessage("Anda harus menyetujui Syarat dan Ketentuan.", 4000);
                return;
            }

            // Pastikan semua input tersembunyi (hidden input) terisi dengan data terbaru sebelum pengiriman
            updateSummary();

            // Buat objek FormData dari form untuk memudahkan pengiriman data
            const formData = new FormData(orderForm);

            try {
                // Kirim data menggunakan Fetch API (pengiriman AJAX)
                const response = await fetch(orderForm.action, {
                    method: orderForm.method,
                    body: formData, // Mengirim data sebagai FormData
                    headers: {
                        'Accept': 'application/json' // Memberitahu Formspree untuk merespons dengan JSON
                    }
                });

                if (response.ok) {
                    showMessage("Pesanan Anda berhasil ditempatkan!", 5000);
                    // Reset form dan state setelah berhasil dikirim
                    orderForm.reset(); // Mereset semua input dalam form HTML
                    cart = {}; // Mengosongkan keranjang JavaScript
                    selectedRestaurants = []; // Mereset pilihan restoran
                    totalDeliveryFee = 0; // Mereset biaya pengiriman
                    // Pastikan checkbox restoran juga direset secara visual
                    document.querySelectorAll('input[name="selectedRestaurant[]"]').forEach(checkbox => checkbox.checked = false);
                    loadMenuForSelectedRestaurants(); // Memuat ulang menu (akan kosong)
                } else {
                    // Tangani jika Formspree merespons dengan kesalahan
                    const errorData = await response.json();
                    showMessage(`Gagal menempatkan pesanan: ${errorData.error || response.statusText}. Coba lagi nanti.`, 6000);
                    console.error('Formspree error:', errorData);
                }
            } catch (error) {
                // Tangani kesalahan jaringan atau lainnya
                showMessage(`Terjadi kesalahan jaringan: ${error.message}. Coba lagi nanti.`, 6000);
                console.error('Fetch error:', error);
            }
        });

        // Pastikan seluruh DOM sudah dimuat sebelum menjalankan inisialisasi script.
        // Ini mencegah error jika script mencoba mengakses elemen yang belum ada di halaman.
        document.addEventListener('DOMContentLoaded', () => {
            loadMenuForSelectedRestaurants(); // Panggil fungsi ini di awal untuk inisialisasi tampilan menu
        });
    </script>
</body>
</html>
